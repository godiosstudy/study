;(function(){
  const LS_KEY = 'prefs.language';
  const SUPPORTED = ['en','es'];

  function normalize(code){
    code = (code || '').toLowerCase();
    if (code.startsWith('en')) return 'en';
    if (code.startsWith('es')) return 'es';
    return 'es';
  }

  function getDeviceLanguage(){
    try { return normalize(navigator.language || (navigator.languages && navigator.languages[0]) || 'es'); }
    catch { return 'es'; }
  }

  function getLocalLanguage(){
    try { return normalize(localStorage.getItem(LS_KEY)); } catch { return null; }
  }

  function setLocalLanguage(code){
    try { localStorage.setItem(LS_KEY, normalize(code)); } catch {}
  }

  function getPrefsLanguage(){
    try { return normalize(window.PrefsStore?.load()?.p_language_code); } catch { return null; }
  }

  function applyDomainLabel(lang){
    const el = document.getElementById('hdr-domain');
    if (!el) return;
    const label = (window.I18n?.__TR?.[lang]?.domain?.title) || "Study.GODiOS.org";
    el.textContent = label;
  }

  function setLang(code, opts={}){
    const lang = normalize(code);
    try { document.documentElement.setAttribute('lang', lang); } catch {}
    const prefs = (window.PrefsStore && window.PrefsStore.load && window.PrefsStore.load()) || null;
    if (prefs) {
      if (prefs.p_language_code !== lang){
        const next = { ...prefs, p_language_code: lang };
        try { window.PrefsStore.save(next); window.PrefsStore.apply(next); } catch {}
      } else {
        try { window.PrefsStore.apply(prefs); } catch {}
      }
    } else {
      setLocalLanguage(lang);
      window.dispatchEvent(new CustomEvent('prefs:applied', { detail: { p_language_code: lang } }));
    }
    applyDomainLabel(lang);
    window.dispatchEvent(new CustomEvent('i18n:changed', { detail: { lang } }));
  }

  function getLang(){
    const fromPrefs = getPrefsLanguage();
    if (fromPrefs) return fromPrefs;
    const local = getLocalLanguage();
    if (local) return local;
    return getDeviceLanguage();
  }

  function t(path, fallback){
    const lang = getLang();
    const parts = (path || '').split('.');
    let cur = window.I18n && window.I18n.__TR && window.I18n.__TR[lang];
    for (const p of parts){
      if (!cur) break;
      cur = cur[p];
    }
    return (cur != null ? cur : (fallback != null ? fallback : path));
  }

  window.addEventListener('auth:changed', (ev)=>{
    const user = ev && ev.detail;
    const lang = user && user.p_language_code;
    if (lang) setLang(lang);
  });

  function mountLanguageSelect(selectEl, current){
    const langs = [
      { code: 'en', label: 'English' },
      { code: 'es', label: 'EspaÃ±ol' },
    ];
    selectEl.innerHTML = '';
    langs.forEach(({code,label})=>{
      const opt = document.createElement('option');
      opt.value = code; opt.textContent = label;
      if (normalize(current) === code) opt.selected = true;
      selectEl.appendChild(opt);
    });
    selectEl.addEventListener('change', ()=> setLang(selectEl.value));
  }

  window.I18n = window.I18n || {};
  window.I18n.getLang = getLang;
  window.I18n.setLang = setLang;
  window.I18n.t = t;
  window.I18n.mountLanguageSelect = mountLanguageSelect;

  const initial = getLang();
  setLang(initial);

  // Back-compat shim for existing code expecting window.LanguagePrefs.mountLanguageSelect
  window.LanguagePrefs = window.LanguagePrefs || {};
  window.LanguagePrefs.mountLanguageSelect = mountLanguageSelect;
})();